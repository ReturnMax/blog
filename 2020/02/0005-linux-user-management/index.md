# Linux 之权限管理

Linux系统是一个多用户多任务的分时操作系统，每一个需要使用系统资源的用户都需要先由系统管理员创建一个账号，然后以该账号的身份和口令登入系统。  
  
用户的账号既有助于系统管理员控制用户对系统资源的访问权限，也有助于帮助用户组织文件，并为用户提供安全性、隐私性的保护。  

## 文件基本属性  
在学习Linux用户管理之前，我们先来了解关于文件的一些基本概念。  
在Linux系统中有一个基本思想，即“一切皆文件”。控制文件的访问权限非常重要，Linux中针对每一个文件都有属主(User/Owner)、属组(Group)和其他组(Other)的概念，藉此可以管理不同用户访问同一文件的权限。  
<br />
在Linux系统中，我们可以使用`ls -l`命令来显示一个文件的属性及其所属的用户和组，如：  
```bash
root@guoc:/# ls -l
total 7
...
drwxrw-r-- 1 root root 4096 Otc 18 2020 bin  
----------   ---- ----                  ---
 类型及权限   属主  属组                 文件
...
```
### 属性 
首字段`drwxrw-r--`描述了文件的类型及不同用户的权限(Permission)。  

|文件类型|属主权限|属组权限|其他用户权限|
|:-:|:-:|:-:|:-:|
|d|r&ensp;w&ensp;x|r&ensp;w&ensp;-|r&ensp;-&ensp;-|
|0|1&ensp;2&ensp;3|4&ensp;5&ensp;6|7&ensp;8&ensp;9| 
|目录文件|读写执行|读写|读|  
    
其中，首字符表示文件类型：  
`d`为目录，`-`为文件，`l`为链接文档，`b`为可供存储的接口设备，`c`为串行端口设备。  

接下来的字符中，`rwx`三个一组，分别表示`read`、`write`和`execute`权限，`-`表示没有对应的权限。  

总体来看，第0位确定文件类型，第1-3位确定属主拥有该文件的权限， 
第4-6位确定属组拥有该文件的权限，第7-9位确定其他用户拥有该文件的权限。  


### 属主(User/Owner)  
属主是文件的所有者。默认情况下，属主为该文件的创建者，谁创建了这个文件，谁就自然的成为了该文件的所有者。  

### 属组(Group)  
在Linux系统中，用户是按组分类的，一个用户属于一个或多个组，属于同一个组的用户对同一文件拥有相同的访问权限。  
当一个用户创建了一个文件后，默认该用户所在的组就是这个文件的属组。通过设定文件的属组，我们可以集中管理属组内所有用户对这个文件的访问权限。  

**注意：**  
1. 默认情况下，文件的属主和属组分别为该文件的创建者及其所在的用户组，但我们也可以更改文件的属主和属组。因此，一些教程中把文件的属组解释为文件属主所在的组，或者把属组用户解释为与属主同组的用户，这种理解并不正确。
2. 上面的例子中，虽然属主和属组都为root，但是属主字段为**用户**`uid`，属组字段为**用户组**`gid`，前者代表单个用户账号，后者代表账号的集合。我们在创建新用户时，会默认创建一个同名的用户组，但是两者之间并不等价。  
3. 对每一个文件来说，除属主以外的用户再划分为属组用户和其他用户，三者之间的权限彼此独立。比如：
    ```bash
	d---rw-r-- 1 usr usr 4096 Otc 18 2020 bin
    ```
    假设属主usr的gid为usr，此时属主没有读写执行bin文件的权限，但是与属主同组的其他用户拥有读写bin文件的权限。  
  
### 其他组(Other)  
除去文件属主和属组用户以外的用户为其他组用户。   
  
## 文件属性管理  
### 更改文件属主 
**Root用户**可以使用`chown`命令更改文件的属主，也可以同时更改文件的属组。  
```bash
chown [-R] User[:Group] {File|Directory...}
```
`[  ]`内为可选参数。  
-R 为递归更改，当更改目录文件时，加上该参数可以递归更改目录及目录下所有文件的属主。  

### 更改文件属组  
**Root用户**和**文件属主**可以使用`chgrp`命令更改文件属组，前者更改没有限制，后者只可将属组改为自己是其成员的组。  
```bash
chgrp [-R] User {File|Directory...}
```
-R 为可选参数。当更改目录文件时，加上该参数可以递归更改目录及目录下所有文件的属组。  
  
### 更改文件权限  
**Root用户**和**文件属主**可以使用`chmod`命令更改文件权限。  
更改文件权限有两种方式，分别为数字模式(Numeric Mode)和符号模式(Symbolic Mode)。  
#### 数字模式  
数字模式中`r``w``x`权限分别用分数表示：  
- `r`：4  
- `w`：2  
- `x`：1  
  
三种权限的分数累加之和代表User、Group和Other用户的权限。举个例子，`[-rwxrw----]`分数计算如下：  
- `User = rwx = 4 + 2 + 1 = 7`  
- `Group = rw- = 4 + 2 + 0 = 6`
- `Other = --- = 0 + 0 + 0 = 0`  

因此，该文件的权限数字可以用`760`表示。  
更改权限的时我们输入如下命令：    
```bash
chmod [-R] xyz {File|Directory...}
```  
其中xyz就是按照上述方法计算出的用户权限。
#### 符号模式  
符号模式中使用`u`，`g`，`o`分别表示`User`，`Group`，`Other`，用`a`来表示`All`，即全部的身份。此外，使用`+`，`-`，`=`分别表示添加、除去和设定权限。  

举个例子，我们设定`test`文件的权限为`-rwxr-xr--`，可以使用以下命令：  
```bash
chmod u=rwx,g=rx,o=r test
```
现在我们使用以下命令，除去`test`文件所有用户的执行权限：  
```bash
chmod a-x test
```
## 用户管理  
Linux是一个多用户的操作系统，支持多个用户同时登录。用户角色可分为三类，分别为root用户、伪用户和普通用户。  
<br />
Root用户系统唯一，具有系统的最高权限，可以操作任何的文件和命令。  
伪用户是系统运行必不可少的用户，比如bin、daemon、adm、ftp、mail等用户。这些用户通常都是系统自身拥有的，不具备登录系统的能力。  
普通用户和root用户一样，都是真实用户，可以登录系统。但是普通用户的权限有限，通常都是由系统管理员自行添加。  
<br />
用户账号的管理主要涉及到用户账号的添加、修改和删除，我们来分别介绍这几部分的内容。  
### 添加新用户账号  
添加用户账号就是在系统中创建一个新账号，然后为新账号分配用户号、用户组、主目录和登录Shell等资源。刚添加的账号是被锁定的，无法使用。  
通过使用`useradd`命令添加新的用户账号，语法如下：  
```bash
useradd [option] username
```
选项说明：  
- `-c`&emsp;comment&emsp;指定一段注释性描述  
- `-d`&emsp;指定用户主目录，如果此目录不存在，添加-m选项可以创建主目录  
- `-g`&emsp;指定用户所属的用户组&emsp;  
- `-G`&emsp;指定用户所属的附加组，有多个附加组则用逗号隔开  
- `-s`&emsp;指定用户的登录Shell  
- `-u`&emsp;指定用户的用户号  
  
举个例子：  
```bash
useradd -d /home/gavin -m -s /bin/bash -g group -G root,adm gavin
```
该命令添加了一个名为`gavin`的新用户，`-d`和`-m`选项为该用户创建了主目录`/home/gavin`，登录shell为`bash`，他属于`group`用户组，同时也属于`root`和`adm`用户组，其中`group`是他的主用户组。  
<br />
添加新用户账号就是系统在/etc/passwd文件中增加一条新纪录，同时更新其他系统文件，如/etc/group和/etc/shadow等，详细介绍见第五节[「用户和用户组配置文件」](#用户和用户组配置文件)。  

### 指定或修改用户密码  
刚创建的用户没有密码，被系统锁定无法使用，需要为其指定密码后才可以使用，即使是指定空的密码。  
使用`passwd`命令指定或修改用户密码，语法如下：  
```bash
passwd [option] username
```
选项说明：  
- `-l`&emsp;锁定密码，禁用账号  
- `-u`&emsp;密码解锁  
- `-d`&emsp;使账号没有密码  
- `-f`&emsp;强迫用户下次登录时修改密码  
- 如果username为空，则默认修改当前用户的密码  

### 修改用户
修改用户账号就是根据实际业务需求更改用户的相关书信，如用户组、登录Shell等。  
使用`usermod`命令修改用户属性，语法如下：  
```bash
usermod [option] username
```
选项说明：  
- `-l newname` 修改用户名  
- 其它可参考`useradd`命令，如`-d`，`-g`，`-a -G`，`-s`。  

### 删除用户  
我们可以使用`userdel`命令执行删除用户的操作，语法如下：  
```bash
userdel [option] username
```  
常用的选项是`-r`，它的作用是将该用户的主目录一起删除，不添加的话会保留该用户的主目录。  
举个例子：  
```bash
userdel -r gavin
```
该命令会删除用户`gavin`在系统文件，如/etc/passwd，/etc/shadow，/etc/group中的相应记录，同时删除用户的主目录。  

## 用户组管理
用户组是具有相同权限的一组用户，通过用户组我们可以集中管理用户组中所有用户的权限。  
默认情况下，Linux系统中创建的用户属于与它同名的用户组，这个用户组在创建用户时同时建立。  
用户组的管理主要包括用户组的添加、删除和修改，本质上是对/etc/group文件的更新。  
### 增加用户组  
使用`groupadd`命令增加新的用户组，语法如下：  
```bash
groupadd [-g] groupname
```
举个例子：  
```bash
groupadd -g 100 gavin
```  
我们在系统中添加了一个名为`gavin`的新用户组，并指定新组的组标识号gid为100；如果不添加-g参数，那么新组的组标识号是在当前已有的最大组标识号的基础上加1。  
### 修改用户组  
修改用户组属性使用`groupmod`命令，语法如下：  
```bash
groupmod [option] group
```
选项说明：  
- `-g` 为用户指定新的组标识号  
- `-n newgroup` 将用户组名改为新名字  
举个例子：  
```bash
groupmod -g 2020 -n kavin gavin
```
该命令将gavin用户组更名为kavin，并将组标识号改为2020。  

### 删除用户组  
删除用户组使用`groupdel`命令，语法如下：  
```bash
groupdel group
```
## 用户和组配置文件
在Linux系统中，与用户和用户组相关的信息保存在一些系统文件中，主要包括以下三个文件:  
- `/etc/passwd`
- `/etc/group`
- `/etc/shadow`

而前文所述的针对用户与用户组的管理，本质上是对这些文件中的相应信息进行修改，接下来让我们详细介绍一下这几个文件。  
### passwd文件
`/etc/passwd`文件存储了当前系统中所有用户的信息。文件的每一行记录都对应着系统中的一个用户，记录了这个用户的一些基本属性。  

文件的内容类似于下面的例子：  
<pre>
root&#58;x:0:0:root:/root:/bin/bash  
daemon&#58;x:1:1:daemon:/usr/sbin:/usr/sbin/nologin  
bin&#58;x:2:2:bin:/bin:/usr/sbin/nologin  
sys&#58;x:3:3:sys:/dev:/usr/sbin/nologin  
···
</pre>  
文件中每个用户的信息格式是固定的，每行记录用（:）分隔为七个字段，每个字段的说明如下：  

|user:|x:|123:|456:|xxx:|/home/user:|/bin/bash|  
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|  
|用户名|密码占位符|UID|GID|注释性描述|主目录|登录Shell|  

### shadow文件
由于/etc/passwd文件所有用户都可读，用户的密码太简单或规律比较明显会被轻易破解。因此Linux系统中把加密后的密码分离出来，单独保存放在`/etc/shadow`文件中。只超级用户才拥有该文件的读取权限，保证了用户密码的安全性。  
  
shadow文件中的记录与passwd中的用户记录一一对应，记录格式也类似，由（:）分割成的多个字段组成。

举个例子：  
<pre>
root:Dnakfw28zf38w:8764:0:168:7:::
daemon:*::0:0::::
bin:*::0:0::::
sys:*::0:0::::  
</pre>
字段说明如下：  

`登录名:加密密码:最后一次修改时间:最小时间间隔:最大时间间隔:警告时间:不活动时间:失效时间:标志`  

### group文件
用户和用户组之间存在一对一、一对多和多对一的关系。  
在`passwd`文件中记录的是用户所属的主组，即登录时所属的默认组。除主组以外，用户也可以属于其他多个组，这些组称为用户的附加组。  
用户组的信息保存在`/etc/group`文件中，文件内容的格式与`passwd`相似，也是由（:）隔开的字段组成，举个例子：  
<pre>
root&#58;x:0:root
bin&#58;x:2:root,bin
sys&#58;x:3:root,uucp
···
gavin&#58;x:5:gavin,kavin 
</pre>  
各个字段的说明如下：  
`组名:密码:组标识号(GID):组内用户列表`  

此外，用户组也有一个对应的`/etc/gshadow`文件保存用户组密码，在此不作具体介绍。

## 常用命令总结
|命令|说明|  
|:---|:---|  
|`chmod [option] file`| 修改文件权限|  
|`chown user file`| 修改文件属主|  
|`chgrp group file`| 修改文件属组|
|`whoami`| 查询当前登录用户名|  
|`id user`| 查询指定用户信息，包括`uid`、`gid`和`groups`<br />如果不指定用户名则显示当前登录用户信息|  
|`groups user`| 查询指定用户所属的组，显示的第一个组是当前用户的主要组<br />如果不指定用户名则显示当前登录用户所属的组|  
|`newgrp group`| 如果用户同时属于多个用户组，该命令用于当前登录用户在不同组间切换，<br/>以便具有其他用户组的权限，切换的组必须是当前用户的主组或附加组|  
|`su user`| 切换登录用户，不指定用户名则切换为root用户<br />切换后$表示普通用户，#表示超级用户|  
|`useradd [option] user`| 添加新用户|
|`passwd [option] user`| 指定或修改用户密码，添加新用户后需指定密码后才可使用|
|`usermod [option] user`| 修改用户信息|  
|`userdel [-r] user`| 删除指定用户，-r删除用户主目录|  
|`groupadd group`| 添加新用户组|
|`groupdel group`| 删除指定用户组|
|`groupmod group`| 修改指定用户组|


## 待补充问题  
1. 添加新用户后，切换到该用户只显示一个`$`符号，而不是常见的`user@***`的格式；而且一些命令，如`ll`也无法使用，请问为什么？  

	解决办法：将用户登录Shell设置为/bin/bash即可。
2. 从权限高的用户切换到权限低的用户不需要输入密码，反之需要。

<!--more-->
