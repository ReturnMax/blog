# Ali ECS 实例配置


趁着过年期间阿里云的新客活动，忍痛购买了3年的ECS云服务器，顺便可以给自己的域名挂上良民证，奥利给！  

但是由于今年疫情的原因，备案时间会比较长，据说需要20天左右。而且之前一直只是在用Linux Client，于是趁着备案期间先熟悉一下阿里云Linux Server的使用和设置，下面是一些零零散散的踩坑记录。  
<!--more-->  
## 密码  
管理密码是一件非常头疼的事情，每次设置完密码都会陷入沉思，"woc...马什么梅来?"。  
ECS实例创建后主要使用的有两个密码，分别是实例密码和远程连接密码。    
* 实例密码  
实例密码是Linux操作系统的密码，就是Root用户密码。奇怪的是创建实例时没有任何初始密码的提示，我是在创建完成后在服务控制台进行的密码重置，需要注意的是重置密码需要重启实例后才会生效。  
* 远程连接密码  
远程连接密码是指阿里云控制台自带的远程连接工具的密码，这个密码最初是系统自动生成的6位数字，用户可以自定义修改这个远程连接密码。  

事实上，如果我们不使用阿里云控制台自带的VNC远程连接工具，那么就用不到远程连接密码。更改远程连接密码无需重启直接生效；实例密码是Linux系统下的root密码，Windows系统下的administrator密码，修改实例密码必须重启实例才可以生效。  

## 网络  
阿里云面向客户提供的网络类型服务有经典网络和专有网络两种，官方文档给的解释是：  
* 经典网络  
ip地址由阿里云统一分配，配置简便，使用方便，适合对操作易用性要求比较高、需要快速使用 ECS 的用户。  
* 专有网络  
是指逻辑隔离的私有网络，您可以自定义网络拓扑和 ip 地址，支持通过专线连接。适合于熟悉网络管理的用户。  
 
我们通俗点理解就是，经典网络和专有网络公网使用同一个公网ip。但是从内网ip来看，经典网络是DHIP，也就是系统自动分配局域网ip地址，而专有网络则是手动分配局域网ip地址，方便有多台云服务器的用户自行定义内网ip结构。所以，如果我们只有一台服务器，或者有多台服务器但不需要进行内网互联，那么这两种网络任选一个就可以了。官方推荐使用专有网络。  

## 带宽  
+ 入网带宽（上行带宽）  
	流入云服务器ECS的带宽，例如：  
	- 云服务器ECS下载外部网络资源  
	- FTP客户端上传资源到云服务器ECS   
+ 出网带宽（下行带宽）  
	流出云服务器ECS的带宽，例如：  
	- 云服务器ECS对外提供访问  
	- FTP客户端下载云服务器ECS内部资源  

## 安全组  
安全组是ECS实例的虚拟防火墙，用于设置实例的网络访问控制，允许或拒绝公网请求和内网请求。  
安全组具备状态检测和数据包过滤功能，可以设置单台或多台云服务器的网络访问控制。  
<br />
每个实例必须属于至少一个安全组，一个安全组可以包括多个实例。同一安全组内的实例之间默认内网互通，不同安全组的实例之间默认内网不通，可以授权两个安全组之间互访。  
在创建实例时，系统会提供一个默认安全组，默认安全组中的默认规则仅设置针对ICMP协议、SSH 22端口、RDP 3389端口、HTTP 80端口和HTTPS 443端口的入方向规则。  
<br />
我们也可以自行创建一个安全组并添加满足自己业务需求的安全组规则，自行创建的安全组在未添加任何安全组规则之前，出方向允许所有访问，入方向拒绝所有访问。  

### 添加规则  
一般场景下我们需要设置的选项主要有两个：端口范围和授权对象，其他可参考默认设置。  
* 端口范围  
端口取值范围从1到65535，设置格式例如1/200或者80/80，其中“-1/-1”不能单独设置，代表不限制端口。  
* 授权对象  
可以填写单个ip地址，例如223.78.253.196/32，填写0.0.0.0/0表示允许/拒绝全网段访问指定端口。  
可以填写多个ip地址，彼此之间用逗号隔开。  
此外还可以指定ip地址段，如 223.78.253.196/31，这将会授权/拒绝223.78.253.196和223.78.253.197的连接。  

### 规则优先级
同类型规则间依赖优先级（手动建立1-100，系统建立110）决定最终执行的规则。当ECS实例加入了多个安全组时，多个安全组会从高到低依次匹配规则。优先级取值范围如下所示，数值越小，优先级越高。

### 实践建议  
* 仅允许少量请求访问ECS实例时，可以将安全组作为白名单使用。即先设置安全组为拒绝全部访问，然后逐一添加允许通信的访问请求策略。  
* 选择开放具体的端口，如80/80端口，不要设置为端口范围。  
* 添加安全组规则时，谨慎授权0.0.0.0/0（全网段）访问源。  

### 一个例子   
如果您在实例上架设了一个网站，希望您的用户能通过HTTPS服务访问到您的网站，您需要在实例所在安全组中添加以下安全组规则。  

|网络类型|网卡类型|规则方向|授权策略|协议类型|端口范围|授权类型|授权对象|优先级|  
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|  
|VPC|不需要配置|入方向|允许|HTTPS|443|地址段访问|0.0.0.0/0|1|  
|经典网络|公网|入方向|允许|HTTPS|443|地址段访问|0.0.0.0/0|1|  

## 远程连接  
Secure Shell（SSH）是一种加密网络协议，通过对传输内容进行加密在不安全的网络上安全地操作网络服务，常用于用户远程登录到计算机系统，详细请戳[「SSH 原理 & 实践」](https://belldrum.com/2020/02/0009-ssh-intro2/)。  
<br />
连接之前我们需要确认安全组中已开放22端口，确认之后我们可以通过用户名密码验证和SSH密钥对验证两种方式远程连接服务器实例。密钥验证相对更加安全，而且阿里云密钥验证的设置也非常简便，直接在控制台中即可一键完成，因此我们推荐使用密钥认证的方式连接服务器。  
<br />
首先在 `云服务控制台 > 网络与安全 > 密钥对` 中创建密钥对并绑定实例，该密钥由ECS生成，默认采用RSA 2048位的加密方式。密钥绑定后，公钥会自动分发给绑定的实例，我们只需要把私钥保存到本地，然后便可通过XShell等工具连接实例了。  
<br />
绑定和解绑密钥时需要注意：  
* 如果使用SSH密钥对登录Linux实例，将会禁用密码登录，以提高安全性。  
	如果在绑定密钥对之后想使用密码方式登录实例，可以通过重置实例密码实现。如果在绑定密钥对之后重置了实例密码，使用密钥对方式和使用密码方式均能登录实例。  
* 基于数据安全考虑，在实例状态为运行中（Running）时绑定或者解绑密钥对，我们需要重启实例使操作生效。  

## 防火墙
**特别提醒**  
<u>远程使用ufw注意开启远程连接的端口，或者在测试时设置定时关闭防火墙的脚本，防止自己连接不上</u>  
<br />
UFW，即<ruby><rb>简单防火墙</rb><rt>uncomplicated firewall</rt></ruby>，是Ubuntu下的一个简易防火墙配置工具。  
UFW是iptables的前端，简化了iptables复杂的配置过程，使用起来很方便。默认情况下UFW是没有开启的，我们通过以下命令可以启动UFW：  
```bash
ufw enable
ufw default deny
```
其中第一条命令是启动ufw，并设置为开机启动；第二条命令是使用ufw默认的规则，即关闭所有的外部对本机的访问，但本机访问外部正常。  
我们也可以关闭ufw和开机启动，命令如下：
```bash
ufw disable
```  
使用allow命令打开指定的端口，举个例子，我们打开22和80端口：  
```bash
ufw allow 22
ufw allow 80
```
指定允许来自某一个ip或网段的连接：  
```bash
ufw allow from 192.168.1.1/24
```
使用`delete allow`删除已经添加过的规则，举个例子，我们禁用80端口：  
```bash
ufw delete allow 80
```
规则设置完成后，我们可以重新加载来使规则生效（不重新加载也会生效?），命令如下：
```bash
ufw reload
```
现在可以通过以下命令查看防火墙的状态：
```bash
ufw status
```
我们配置了很多规则，但是现在需要抛弃它们重新配置，我们可以这么做：  
```bash
ufw reset
```
更多配置选项可以参考UFW手册 `man ufw`。
