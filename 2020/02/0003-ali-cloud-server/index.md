# Ali云服务器配置

## 阿里云ECS服务器配置  
趁着过年期间阿里云的新客活动，忍痛购买了3年的ECS云服务器，顺便可以给自己的域名挂上良民证，奥利给！  

但是由于今年疫情的原因，备案时间会比较长，据说需要20天左右。而且之前一直只是在用Linux Client，于是趁着备案期间先熟悉一下阿里云Linux Server的使用和设置，下面是一些零零散散的~踩坑~学习记录。  

### 密码  
管理密码是一件非常头疼的事情，每次设置完密码都会陷入沉思，"woc...马什么梅来?"。  
ECS实例创建后主要使用的有两个密码，分别是实例密码和远程连接密码。    
* 实例密码  
实例密码是Linux操作系统的密码，就是Root用户密码。奇怪的是创建实例时没有任何初始密码的提示，我是在创建完成后在服务控制台进行的密码重置，需要注意的是重置密码需要重启实例后才会生效。  
* 远程连接密码  
远程连接密码是指阿里云控制台自带的远程连接工具的密码，这个密码最初是系统自动生成的6位数字，用户可以自定义修改这个远程连接密码。  

事实上，如果我们不使用阿里云控制台自带的VNC远程连接工具，那么就用不到远程连接密码。更改远程连接密码无需重启直接生效；实例密码是Linux系统下的root密码，Windows系统下的administrator密码，修改实例密码必须重启实例才可以生效。  

## 网络  
阿里云面向客户提供的网络类型服务有经典网络和专有网络两种，官方文档给的解释是：  
* 经典网络  
ip地址由阿里云统一分配，配置简便，使用方便，适合对操作易用性要求比较高、需要快速使用 ECS 的用户。  
* 专有网络  
是指逻辑隔离的私有网络，您可以自定义网络拓扑和 ip 地址，支持通过专线连接。适合于熟悉网络管理的用户。  
 
我们通俗点理解就是，经典网络和专有网络公网使用同一个公网ip。但是从内网ip来看，经典网络是DHIP，也就是系统自动分配局域网ip地址，而专有网络则是手动分配局域网ip地址，方便有多台云服务器的用户自行定义内网ip结构。所以，如果我们只有一台服务器，或者有多台服务器但不需要进行内网互联，那么这两种网络任选一个就可以了。  

## 带宽  
+ 入网带宽（上行带宽）  
	流入云服务器ECS的带宽，例如：  
	- 云服务器ECS下载外部网络资源  
	- FTP客户端上传资源到云服务器ECS   
+ 出网带宽（下行带宽）  
	流出云服务器ECS的带宽，例如：  
	- 云服务器ECS对外提供访问  
	- FTP客户端下载云服务器ECS内部资源  

## 安全组  
安全组是ECS实例的虚拟防火墙，用于设置实例的网络访问控制，允许或拒绝公网请求和内网请求。  
安全组具备状态检测和数据包过滤功能，可以设置单台或多台云服务器的网络访问控制。  
每个实例必须属于至少一个安全组，一个安全组可以包括多个实例。同一安全组内的实例之间默认内网互通，不同安全组的实例之间默认内网不通，可以授权两个安全组之间互访。  
在创建实例时，系统会提供一个默认安全组，默认安全组中的默认规则仅设置针对ICMP协议、SSH 22端口、RDP 3389端口、HTTP 80端口和HTTPS 443端口的入方向规则。  
我们也可以自行创建一个安全组并添加能满足自己业务需求的安全组规则，自行创建的安全组在未添加任何安全组规则之前，出方向允许所有访问，入方向拒绝所有访问。  

### 添加安全组规则  
一般场景下我们需要设置的选项主要有两个：端口范围和授权对象，其他可参考默认设置。  
* 端口范围  
端口取值范围从1到65535，设置格式例如1/200或者80/80，其中“-1/-1”不能单独设置，代表不限制端口。  
* 授权对象  
可以填写单个ip地址，例如223.78.253.196/32，填写0.0.0.0/0表示允许/拒绝全网段访问指定端口。  
可以填写多个ip地址，彼此之间用逗号隔开。  
此外还可以指定ip地址段，如 223.78.253.196/31，这将会授权/拒绝223.78.253.196和223.78.253.197的连接。  

### 规则优先级
同类型规则间依赖优先级（手动建立1-100，系统建立110）决定最终执行的规则。当ECS实例加入了多个安全组时，多个安全组会从高到低依次匹配规则。优先级取值范围如下所示，数值越小，优先级越高。

### 实践建议  
* 仅允许少量请求访问ECS实例时，可以将安全组作为白名单使用。即先设置安全组为拒绝全部访问，然后逐一添加允许通信的访问请求策略。  
* 选择开放具体的端口，如80/80端口，不要设置为端口范围。  
* 添加安全组规则时，谨慎授权0.0.0.0/0（全网段）访问源。  

### 案例   
如果您在实例上架设了一个网站，希望您的用户能通过HTTPS服务访问到您的网站，您需要在实例所在安全组中添加以下安全组规则。  

|网络类型|网卡类型|规则方向|授权策略|协议类型|端口范围|授权类型|授权对象|优先级|  
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|  
|VPC|不需要配置|入方向|允许|HTTPS|443|地址段访问|0.0.0.0/0|1|  
|经典网络|公网|入方向|允许|HTTPS|443|地址段访问|0.0.0.0/0|1|  

## SSH连接实例   
Secure Shell（SSH）是一种加密网络协议，通过对传输内容进行加密在不安全的网络上安全地操作网络服务，常用于用户远程登录到计算机系统。  
SSH不是本文介绍的重点，详细请看这篇[文章](daibuchong)，本文主要介绍阿里云SSH配置。  
### Root用户  
首先，我们需要在安全组中开放入方向的22端口（默认已经开启），确认开启之后我们可以通过用户名密码验证和SSH密钥对验证两种方式远程连接服务器实例。密钥验证相对更加安全，而且阿里云的SSH密钥设置也非常简便，直接在控制台中即可完成。  
首先我们在 `云服务控制台 > 网络与安全 > 密钥对` 中创建密钥对并绑定实例，该密钥由ECS生成，默认采用RSA 2048位的加密方式。密钥绑定后，公钥会自动保存在实例中，我们把私钥保存到本地，然后便可通过Xshell等工具连接实例了。  
### 非Root用户  

### 实践注意事项  
使用SSH密钥需要注意两点：  
* 如果使用SSH密钥对登录Linux实例，将会禁用密码登录，以提高安全性。  
	如果在绑定密钥对之后想使用密码方式登录实例，可以通过重置实例密码实现。如果在绑定密钥对之后重置了实例密码，使用密钥对方式和使用密码方式均能登录实例。  
* 基于数据安全考虑，在实例状态为运行中（Running）时绑定或者解绑密钥对，您需要重启实例使操作生效。  

### 安全优化
#### 修改22端口
Linux默认使用22端口进行远程登录，有一些人专门用服务器扫描22端口并使用弱口令等进行暴力破解，我们通过更改22端口可以过滤掉大部分暴力破解的访问。  
<ruby><rb>SSH服务</rb><rt>ssh daemon</rt></ruby>是OpenSSH软件套件中运行在服务器端的守护进程，作为服务器监听连接请求，它的配置文件是`/etc/ssh/sshd_config`。  
修改之前我们先备份配置文件，然后再进行编辑：  
```bash
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak
vim /etc/ssh/sshd_config
```
打开后可以看到如下内容：  
<pre>
	#	$OpenBSD: sshd_config,v 1.101 2017/03/14 07:19:07 djm Exp $

	# This is the sshd server system-wide configuration file.  See
	# sshd_config(5) for more information.

	# This sshd was compiled with PATH=/usr/bin:/bin:/usr/sbin:/sbin

	# The strategy used for options in the default sshd_config shipped with
	# OpenSSH is to specify options with their default value where
	# possible, but leave them commented.  Uncommented options override the
	# default value.

	#Port 22
	#AddressFamily any
	#ListenAddress 0.0.0.0
	#ListenAddress ::
</pre>
其中22端口被注释掉了。  
为了防止后续端口修改错误导致无法登录，我们先删除`#`保留`Port 22`端口，然后另起一行添加`Port 2222`，修改后的文件如下：
<pre>
	Port 22
	Port 2222
	#AddressFamily any
	#ListenAddress 0.0.0.0
	#ListenAddress ::
</pre>
修改完成后我们保存退出，重启sshd服务使配置生效：  
```bash
systemctl restart sshd
```
或
```bash
service sshd restart
```

重启完成后，我们可以通过`netstat -ntl`或`ss -ntl`命令查看一下端口。  

配置完成后，记得在防火墙和安全组中放行`2222`端口，然后用新端口重新登录。  
如果登录成功，测试正常后，我们就可以注释或删除掉之前保留的`22`端口了。  

需要注意的是，在`/etc/ssh/`目录下还有一个`ssh_config`文件，它是`ssh`的配置文件，记录了用户常用的选项和连接的主机。sshd(SSH服务器)运行在服务器端，监听incomming connection；ssh运行在客户端，用于客户端使用SSH协议连接其它机器。我们不要错误的修改了`ssh`的配置文件。  

#### SSH禁止root登录
#### SSH密钥登录
#### UFW防火墙
**特别提醒**  
<u>远程使用ufw需要注意开启远程连接的端口，或者设置定时关闭防火墙的脚本，防止自己连接不上</u>  
<br />
UFW，即<ruby><rb>简单防火墙</rb><rt>uncomplicated firewall</rt></ruby>，是Ubuntu下的一个简易防火墙配置工具。  
UFW的使用非常简单，默认情况下UFW是没有开启的，我们使用以下命令就可以启动：  
```bash
ufw enable
ufw default deny
```
其中第一条命令是启动ufw，并将其设置为开机启动；第二条命令是使用ufw默认的规则，即关闭所有的外部对本机的访问，但本机访问外部正常。  
我们也可以关闭ufw防火墙及开机启动，命令如下：
```bash
ufw disable
```  
我们可以使用allow命令打开指定的端口，举个例子，我们打开22和80端口：  
```bash
ufw allow 22
ufw allow 80
```
也可以使用`delete allow`删除已经添加过的规则，举个例子，我们禁用80端口：  
```bash
ufw delete allow 80
```
规则设置完成后，我们可以重新加载来使规则生效（不重新加载也会生效），命令如下：
```bash
ufw reload
```
现在可以通过以下命令查看防火墙的状态：
```bash
ufw status
```
 
- [ ] 禁止root用户登录  
- [ ] 禁止使用口令验证



<!--more-->
